<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body{
    background:#f5f5f5;
    margin:0;
    font-family:'Poppins',sans-serif;
    color:#111;
}

.container{
    max-width:700px;
    margin:auto;
}

/* ---------- Banner ---------- */
.banner{
    width:100%;
    height:180px;
    background:linear-gradient(90deg,#ff874e,#ff4e4e);
    border-bottom-left-radius:20px;
    border-bottom-right-radius:20px;
    position:relative;
}

.profile-icon-box{
    width:110px;
    height:110px;
    background:white;
    border-radius:50%;
    position:absolute;
    left:50%;
    bottom:-55px;
    transform:translateX(-50%);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    border:4px solid #fff;
    cursor:pointer;
}
.profile-icon-box img{
    width:100%;
    height:100%;
    object-fit:cover;
}

/* ---------- Main Card ---------- */
.card{
    margin-top:70px;
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,0.1);
}

.name{
    font-size:20px;
    font-weight:700;
}
.email{
    opacity:.7;
}
.tag{
    background:#ffe1b5;
    padding:4px 10px;
    border-radius:20px;
    font-size:12px;
    margin-right:10px;
}

/* ---------- Stats ---------- */
.stats{
    display:flex;
    justify-content:space-between;
    margin-top:20px;
}
.box{
    width:32%;
    background:#f2f2f2;
    padding:15px 10px;
    border-radius:12px;
    text-align:center;
}
.box-value{
    font-size:22px;
    font-weight:700;
    color:#ff4e4e;
}

/* Add money button */
.add-btn{
    background:#ff4e4e;
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:8px;
    float:right;
    margin-top:10px;
    cursor:pointer;
}

/* ---------- Table ---------- */
.table-card{
    background:white;
    margin-top:25px;
    padding:20px;
    border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,0.1);
}

table{
    width:100%;
    border-collapse:collapse;
}
th,td{
    padding:10px;
    border-bottom:1px solid #eee;
    text-align:left;
}
th{
    background:#fafafa;
    font-weight:600;
}

.empty{
    text-align:center;
    padding:20px 0;
    opacity:.6;
}
</style>
</head>
<body>

<div class="container">

<!-- Banner -->
<div class="banner"></div>

<!-- Profile Photo Upload -->
<div class="profile-icon-box" onclick="document.getElementById('photoInput').click()">
    <img id="profilePhoto" src="https://i.ibb.co/Vwz6SfT/user.png">
</div>
<input type="file" id="photoInput" accept="image/*" style="display:none;">

<!-- Profile Card -->
<div class="card">
    <span class="tag">✔ Verified</span>

    <div class="name" id="name">Loading...</div>
    <div class="email" id="email"></div>
    <div id="joindate" style="opacity:.7; margin-top:5px;"></div>

    <div class="stats">
        <div class="box">
            <div class="box-value" id="balance">0</div>
            <small>Balance</small>
        </div>
        <div class="box">
            <div class="box-value" id="earn">0</div>
            <small>Earn Balance</small>
        </div>
        <div class="box">
            <div class="box-value" id="supportPin">------</div>
            <small>Support PIN</small>
        </div>
    </div>

    <button class="add-btn" onclick="openDeposit()">Add Money</button>
    <div style="clear:both;"></div>
</div>

<!-- Transactions -->
<div class="table-card">
    <h3>All Transactions</h3>

    <table id="txnTable"></table>

    <div class="empty" id="emptyTxn" style="display:none;">No transactions found!</div>
</div>

</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// Firebase Init
const firebaseConfig = {
    apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
    authDomain: "post-c7e41.firebaseapp.com",
    projectId: "post-c7e41",
    databaseURL: "https://post-c7e41-default-rtdb.firebaseio.com",
    storageBucket: "post-c7e41.appspot.com"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const rtdb = firebase.database();
const storage = firebase.storage();

function openDeposit(){
    window.location.href = "add_money.html";
}

// Load Profile + All Txn
auth.onAuthStateChanged(user=>{
    if(!user){ window.location.href = "login.html"; return; }

    document.getElementById("email").innerText = user.email;

    // Support PIN
    document.getElementById("supportPin").innerText = user.uid.slice(-6);

    // Join Date
    const date = new Date(user.metadata.creationTime);
    document.getElementById("joindate").innerText =
        "Joined on " + date.toLocaleDateString();

    // Load profile data (name + photo)
    db.collection("users").doc(user.uid).onSnapshot(doc=>{
        if(doc.exists){
            let data = doc.data();
            document.getElementById("name").innerText = data.name || "No Name";

            if(data.photoURL){
                document.getElementById("profilePhoto").src = data.photoURL;
            }
        }
    });

    // Earn balance from RTDB
    rtdb.ref("users/"+user.uid+"/earned").on("value", snap=>{
        document.getElementById("earn").innerText = snap.val() || 0;
    });

    // Deposit balance
    rtdb.ref("users/"+user.uid+"/deposit").on("value", snap=>{
        document.getElementById("balance").innerText = snap.val() || 0;
    });

    // Transactions from Firestore
    db.collection("transactions")
        .where("uid","==",user.uid)
        .orderBy("time","desc")
        .onSnapshot(snap=>{
            let table = document.getElementById("txnTable");
            let empty = document.getElementById("emptyTxn");

            table.innerHTML = `
                <tr>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Time</th>
                </tr>
            `;

            if(snap.size === 0){
                empty.style.display="block";
                table.style.display="none";
                return;
            }

            empty.style.display="none";
            table.style.display="table";

            snap.forEach(tx=>{
                let t = tx.data();
                table.innerHTML += `
                    <tr>
                        <td>${t.type}</td>
                        <td>${t.amount}৳</td>
                        <td>${t.status}</td>
                        <td>${new Date(t.time).toLocaleString()}</td>
                    </tr>
                `;
            });
        });
});

// -------------------------
// ⭐ PHOTO UPLOAD SYSTEM
// -------------------------
document.getElementById("photoInput").addEventListener("change", function(){
    let file = this.files[0];
    let user = auth.currentUser;

    if(!file || !user) return;

    let path = "profilePhotos/" + user.uid + ".jpg";
    let uploadTask = storage.ref(path).put(file);

    uploadTask.on("state_changed",
        ()=>{},
        ()=> alert("Upload failed"),
        ()=>{
            uploadTask.snapshot.ref.getDownloadURL().then(url=>{
                // Save the URL to Firestore
                db.collection("users").doc(user.uid).update({
                    photoURL: url
                });

                // Update UI
                document.getElementById("profilePhoto").src = url;
            });
        }
    );
});
</script>

</body>
</html>