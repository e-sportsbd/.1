<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lone Wolf Matches</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {margin:0;padding:18px;font-family:'Poppins',sans-serif;background:#f3f3f3;}
.balance-bar {background:#fff;padding:16px;border-radius:18px;box-shadow:0 2px 10px rgba(0,0,0,0.08);font-size:18px;font-weight:700;margin-bottom:15px;}
h2{text-align:center;font-weight:700;margin-bottom:18px;color:#222;}
.match-card{background:#fff;padding:18px;border-radius:18px;box-shadow:0 2px 12px rgba(0,0,0,0.08);margin-bottom:22px;}
.match-title{font-size:22px;font-weight:700;margin-bottom:4px;}
.match-time{font-size:13px;color:#666;margin-bottom:18px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.info-item{background:#fafafa;padding:12px;border-radius:14px;font-size:14px;border:1px solid #eee;}
.label{font-size:12px;color:#888;}
.progress-text{font-size:13px;margin:10px 0;}
.progress-bar{background:#e2e2e2;height:11px;border-radius:20px;width:100%;overflow:hidden;}
.progress-inner{height:100%;background:orange;}
.join-btn,.details-btn{width:100%;padding:13px;border-radius:14px;font-weight:700;border:none;margin-top:12px;font-size:16px;}
.join-btn{background:orange;color:white;}
.joined-btn{background:#27ae60;color:white;}
.deposit-btn{background:#e74c3c;color:white;}
.details-btn{background:#4a6cf7;color:white;}

.popup-bg{position:fixed;left:0;top:0;width:100%;height:100%;backdrop-filter:blur(3px);background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:20;}
.popup-box{width:92%;background:white;padding:20px;border-radius:20px;max-width:420px;}
.popup-title{font-size:20px;font-weight:700;text-align:center;margin-bottom:20px;}
.popup-join{width:100%;padding:13px;background:orange;color:white;border-radius:14px;font-weight:700;border:none;margin-top:10px;}
.popup-cancel{width:100%;padding:13px;background:#ccc;border-radius:14px;border:none;margin-top:10px;font-weight:700;}
.room-info{font-size:16px;margin-top:10px;text-align:center;}
</style>
</head>

<body>

<div class="balance-bar">
    Balance: <span id="balance">0</span> ৳
</div>

<h2>Lone Wolf Matches</h2>

<div id="matchContainer"></div>

<!-- JOIN POPUP -->
<div id="joinPopup" class="popup-bg">
    <div class="popup-box">
        <div class="popup-title" id="popupTitle">Join Match</div>
        <div id="playerFields" style="text-align:left;font-size:15px;"></div>

        <button class="popup-join" onclick="submitJoin()">Join</button>
        <button class="popup-cancel" onclick="closePopup()">Cancel</button>
    </div>
</div>

<!-- DETAILS POPUP -->
<div id="detailsPopup" class="popup-bg">
    <div class="popup-box">
        <div class="popup-title">Match Details</div>
        <div id="detailsContent" class="room-info"></div>
        <button class="popup-cancel" onclick="closeDetails()">Close</button>
    </div>
</div>
<script>
/* FIREBASE CONFIG */
const firebaseConfig = {
    apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
    authDomain: "post-c7e41.firebaseapp.com",
    projectId: "post-c7e41",
    databaseURL:"https://post-c7e41-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const rtdb = firebase.database();
const auth = firebase.auth();

let userId = "";
let depositBalance = 0;
let earnedBalance = 0;
let totalBalance = 0;

let currentMatchId = "";
let currentEntryFee = 0;
let currentPlayerCount = 1;

/* AUTH → LOAD BALANCE */
auth.onAuthStateChanged(user => {
    if (!user) return alert("Please Login!");

    userId = user.uid;

    rtdb.ref("users/" + userId).on("value", snap => {
        let u = snap.val() || {};

        depositBalance = Number(u.deposit || 0);
        earnedBalance  = Number(u.earned  || 0);
        totalBalance = depositBalance + earnedBalance;

        balance.innerText = totalBalance;

        loadMatches();
    });
});

/* LOAD MATCHES */
function loadMatches() {
    db.collection("lonewolf_matches")
        .orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
            let html = "";

            snapshot.forEach(doc => {
                let m = doc.data();

                let joined = m.joinedPlayers?.length || 0;
                let left = m.slotCount - joined;
                if (left < 0) left = 0;

                let percent = (joined / m.slotCount) * 100;

                let alreadyJoined =
                    m.joinedPlayers?.some(x => x.uid === userId);

                let btn = "";

                if (alreadyJoined)
                    btn = `<button class="joined-btn" disabled>✔ Joined</button>`;
                else if (left <= 0)
                    btn = `<button class="joined-btn" disabled>Slot Full</button>`;
                else if (totalBalance < m.entryFee)
                    btn = `<button class="deposit-btn" onclick="location.href='deposit.html'">Deposit</button>`;
                else
                    btn = `<button class="join-btn" onclick="openPopup('${doc.id}', ${m.entryFee}, '${m.matchType}')">Join</button>`;

                html += `
                <div class="match-card">
                    <div class="match-title">${m.matchType} Match</div>
                    <div class="match-time">${m.matchTime}</div>

                    <div class="info-grid">
                        <div class="info-item"><span class="label">Entry Fee:</span> ${m.entryFee}</div>
                        <div class="info-item"><span class="label">Prize:</span> ${m.prizePool}</div>
                        <div class="info-item"><span class="label">Map:</span> ${m.map}</div>
                        <div class="info-item"><span class="label">Slots:</span> ${joined}/${m.slotCount}</div>
                    </div>

                    <div class="progress-text">${joined} Joined — ${left} Left</div>

                    <div class="progress-bar">
                        <div class="progress-inner" style="width:${percent}%"></div>
                    </div>

                    ${btn}
                    <button class="details-btn" onclick="openDetails('${doc.id}')">Details</button>
                </div>`;
            });

            matchContainer.innerHTML = html;
        });
}

/* OPEN JOIN POPUP */
function openPopup(id, fee, type) {
    currentMatchId = id;
    currentEntryFee = fee;

    currentPlayerCount = (type.toUpperCase() === "DUO") ? 2 : 1;

    let fields = "";

    if (currentPlayerCount === 1) {
        fields = `
            <label>Player Name:</label>
            <input id="p1" type="text" placeholder="Enter your name"
            style="width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;">
        `;
    } else {
        fields = `
            <label>Player 1 Name:</label>
            <input id="p1" type="text" placeholder="Enter player 1 name"
            style="width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;">

            <label style="margin-top:10px;display:block;">Player 2 Name:</label>
            <input id="p2" type="text" placeholder="Enter player 2 name"
            style="width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;">
        `;
    }

    playerFields.innerHTML = fields;
    popupTitle.innerText = `${type} Join`;
    joinPopup.style.display = "flex";
}

function closePopup() {
    joinPopup.style.display = "none";
}

/* JOIN MATCH */
async function submitJoin() {

    let name1 = document.getElementById("p1")?.value?.trim();
    let name2 = (currentPlayerCount === 2) ? document.getElementById("p2")?.value?.trim() : null;

    if (!name1 || (currentPlayerCount === 2 && !name2)) {
        return alert("Please enter all required names!");
    }

    let docSnap = await db.collection("lonewolf_matches").doc(currentMatchId).get();
    let m = docSnap.data();

    if (m.joinedPlayers?.some(j => j.uid === userId)) {
        alert("Already Joined!");
        return closePopup();
    }

    let totalFee = currentEntryFee * currentPlayerCount;

    if (totalBalance < totalFee) return alert("Balance কম!");

    let newDeposit = depositBalance;
    let newEarned  = earnedBalance;

    if (newDeposit >= totalFee) {
        newDeposit -= totalFee;
    } else {
        let rest = totalFee - newDeposit;
        newDeposit = 0;
        newEarned -= rest;
    }

    await rtdb.ref("users/" + userId).update({
        deposit: newDeposit,
        earned: newEarned
    });

    let playerData = { 
        uid: userId, 
        time: Date.now(), 
        name1: name1,
        type: currentPlayerCount === 2 ? "DUO" : "SOLO"
    };

    if (currentPlayerCount === 2) playerData.name2 = name2;

    await db.collection("lonewolf_matches").doc(currentMatchId).update({
        joinedPlayers: firebase.firestore.FieldValue.arrayUnion(playerData),
        slotCount: Math.max(0, m.slotCount - currentPlayerCount)
    });

    alert("Successfully Joined!");
    closePopup();
}

/* DETAILS */
function closeDetails() { 
    detailsPopup.style.display = "none"; 
}

async function openDetails(id) {
    detailsPopup.style.display = "flex";
    detailsContent.innerHTML = "Loading...";

    let doc = await db.collection("lonewolf_matches").doc(id).get();
    let m = doc.data();

    let joined = m.joinedPlayers?.some(j => j.uid === userId);

    if (!joined) {
        detailsContent.innerHTML = "<b style='color:red;'>❌ আপনি Join করেননি!</b>";
        return;
    }

    detailsContent.innerHTML = `
        <b>Room ID:</b> ${m.roomId || "Not added"} <br>
        <b>Password:</b> ${m.roomPassword || "Not added"}
    `;
}
</script>

</body>
</html>