<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CS Matches</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {margin:0;padding:18px;font-family:'Poppins',sans-serif;background:#f3f3f3;}
.balance-bar {background:#fff;padding:16px;border-radius:18px;box-shadow:0 2px 10px rgba(0,0,0,0.08);font-size:18px;font-weight:700;margin-bottom:15px;}
h2{text-align:center;font-weight:700;margin-bottom:18px;color:#222;}
.match-card{background:#fff;padding:18px;border-radius:18px;box-shadow:0 2px 12px rgba(0,0,0,0.08);margin-bottom:22px;}
.match-title{font-size:22px;font-weight:700;margin-bottom:4px;}
.match-time{font-size:13px;color:#666;margin-bottom:18px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.info-item{background:#fafafa;padding:12px;border-radius:14px;font-size:14px;border:1px solid #eee;}
.label{font-size:12px;color:#888;}
.progress-text{font-size:13px;margin:10px 0;}
.progress-bar{background:#e2e2e2;height:11px;border-radius:20px;width:100%;overflow:hidden;}
.progress-inner{height:100%;background:orange;}
.join-btn,.details-btn{width:100%;padding:13px;border-radius:14px;font-weight:700;border:none;margin-top:12px;font-size:16px;}
.join-btn{background:orange;color:white;}
.joined-btn{background:#27ae60;color:white;}
.deposit-btn{background:#e74c3c;color:white;}
.details-btn{background:#4a6cf7;color:white;}

.popup-bg{position:fixed;left:0;top:0;width:100%;height:100%;backdrop-filter:blur(3px);background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:20;}
.popup-box{width:92%;background:white;padding:20px;border-radius:20px;max-width:420px;}
.popup-title{font-size:20px;font-weight:700;text-align:center;margin-bottom:20px;}
.player-input{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;margin-bottom:12px;font-size:15px;display:none;}
.popup-join{width:100%;padding:13px;background:orange;color:white;border-radius:14px;font-weight:700;border:none;}
.popup-cancel{width:100%;padding:13px;background:#ccc;border-radius:14px;border:none;margin-top:10px;font-weight:700;}

.room-info{font-size:16px;margin-top:10px;text-align:center;}
</style>
</head>

<body>

<div class="balance-bar">
    Balance: <span id="balance">0</span> ৳
</div>

<h2>CS Matches</h2>
<div id="matchContainer"></div>

<!-- JOIN POPUP -->
<div id="joinPopup" class="popup-bg">
    <div class="popup-box">
        <div class="popup-title">Select Mode</div>

        <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
            <label><input type="radio" name="mode" value="solo" checked> Solo</label>
            <label><input type="radio" name="mode" value="duo"> Duo</label>
            <label><input type="radio" name="mode" value="squad"> Squad</label>
        </div>

        <input id="p1" class="player-input" placeholder="Player 1 Name">
        <input id="p2" class="player-input" placeholder="Player 2 Name">
        <input id="p3" class="player-input" placeholder="Player 3 Name">
        <input id="p4" class="player-input" placeholder="Player 4 Name">

        <button class="popup-join" onclick="submitJoin()">Join Now</button>
        <button class="popup-cancel" onclick="closePopup()">Cancel</button>
    </div>
</div>

<!-- DETAILS POPUP -->
<div id="detailsPopup" class="popup-bg">
    <div class="popup-box">
        <div class="popup-title">Match Details</div>
        <div id="detailsContent" class="room-info"></div>

        <button class="popup-cancel" onclick="closeDetails()">Close</button>
    </div>
</div>

<script>
/* FIREBASE CONFIG */
const firebaseConfig={
    apiKey:"AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
    authDomain:"post-c7e41.firebaseapp.com",
    projectId:"post-c7e41"
};
firebase.initializeApp(firebaseConfig);

const db=firebase.firestore();
const auth=firebase.auth();

let userId="";
let userBalance=0;

/* AUTH — FIRST LOAD BALANCE THEN MATCHES */
auth.onAuthStateChanged(async user=>{
    if(!user) return alert("Please Login!");
    userId=user.uid;

    db.collection("users").doc(userId).onSnapshot(u=>{
        userBalance = u.data().balance || 0;
        balance.innerText = userBalance;

        /* load matches AFTER balance */
        loadCSMatches();
    });
});

/* LOAD MATCHES */
function loadCSMatches(){
    db.collection("cs_matches")
    .orderBy("createdAt","desc")
    .onSnapshot(snapshot=>{
        let html="";

        snapshot.forEach(doc=>{
            let m=doc.data();

            let joined=m.joinedPlayers?m.joinedPlayers.length:0;
            let left=m.slotCount-joined;
            let percent=(joined/m.slotCount)*100;

            let alreadyJoined=m.joinedPlayers?.some(x=>x.uid===userId);

            let btnHTML="";

            if(alreadyJoined){
                btnHTML=`<button class="joined-btn" disabled>✔ Joined</button>`;
            }
            else if(userBalance < m.entryFee){
                btnHTML=`<button class="deposit-btn" onclick="location.href='deposit.html'">Deposit</button>`;
            }
            else{
                btnHTML=`<button class="join-btn" onclick="openPopup('${doc.id}',${m.entryFee})">Join</button>`;
            }

            html += `
            <div class="match-card">
                <div class="match-title">Match ID: ${doc.id}</div>
                <div class="match-time">${m.matchTime}</div>

                <div class="info-grid">
                    <div class="info-item"><span class="label">Entry:</span> ${m.entryFee}</div>
                    <div class="info-item"><span class="label">Prize:</span> ${m.prizePool}</div>
                    <div class="info-item"><span class="label">Map:</span> ${m.map}</div>
                    <div class="info-item"><span class="label">Slots:</span> ${joined}/${m.slotCount}</div>
                </div>

                <div class="progress-text">${joined} Joined — ${left} Left</div>

                <div class="progress-bar">
                    <div class="progress-inner" style="width:${percent}%"></div>
                </div>

                ${btnHTML}
                <button class="details-btn" onclick="openDetails('${doc.id}')">Details</button>
            </div>`;
        });

        matchContainer.innerHTML=html;
    });
}

/* POPUP */
let currentMatchId="";
let currentEntryFee=0;

function openPopup(id,fee){
    currentMatchId=id;
    currentEntryFee=fee;
    joinPopup.style.display="flex";
    updateInputs();
}

function closePopup(){
    joinPopup.style.display="none";
}

/* SHOW INPUT FIELDS BY MODE */
document.querySelectorAll("input[name='mode']").forEach(i=>
    i.addEventListener("change",updateInputs)
);

function updateInputs(){
    let mode=document.querySelector("input[name='mode']:checked").value;

    p1.style.display=p2.style.display=p3.style.display=p4.style.display="none";

    if(mode==="solo") p1.style.display="block";
    if(mode==="duo"){ p1.style.display="block"; p2.style.display="block"; }
    if(mode==="squad"){ p1.style.display="block"; p2.style.display="block"; p3.style.display="block"; p4.style.display="block"; }
}

/* JOIN MATCH */
async function submitJoin(){
    let docCheck=await db.collection("cs_matches").doc(currentMatchId).get();
    let m=docCheck.data();

    if(m.joinedPlayers && m.joinedPlayers.some(j=>j.uid===userId)){
        alert("⚠ আপনি ইতিমধ্যেই Joined!");
        closePopup();
        return;
    }

    let mode=document.querySelector("input[name='mode']:checked").value;

    let players=[];
    if(mode==="solo") players=[p1.value.trim()];
    if(mode==="duo") players=[p1.value.trim(),p2.value.trim()];
    if(mode==="squad") players=[p1.value.trim(),p2.value.trim(),p3.value.trim(),p4.value.trim()];

    if(players.some(n=>n==="")){
        return alert("⚠ সব Player Name লিখুন!");
    }

    let totalFee=currentEntryFee * players.length;

    if(userBalance < totalFee){
        return alert("❌ পর্যাপ্ত ব্যালেন্স নেই!");
    }

    await db.collection("users").doc(userId).update({
        balance: firebase.firestore.FieldValue.increment(-totalFee)
    });

    await db.collection("cs_matches").doc(currentMatchId).update({
        joinedPlayers: firebase.firestore.FieldValue.arrayUnion({
            uid:userId,
            mode:mode,
            players:players,
            time:Date.now()
        })
    });

    alert("✔ ম্যাচ Join সম্পন্ন!");
    closePopup();
}

/* DETAILS POPUP */
function closeDetails(){
    detailsPopup.style.display="none";
}

async function openDetails(id){
    detailsPopup.style.display="flex";
    detailsContent.innerHTML="Loading...";

    let doc=await db.collection("cs_matches").doc(id).get();
    let m=doc.data();

    let joined=m.joinedPlayers?.some(j=>j.uid===userId);

    if(!joined){
        detailsContent.innerHTML="<b style='color:red;'>❌ আপনি Joined নন!</b>";
        return;
    }

    detailsContent.innerHTML=`
        <b>Room ID:</b> ${m.roomId || "Not added"} <br>
        <b>Password:</b> ${m.roomPassword || "Not added"}
    `;
}
</script>

</body>
</html>